# 网页爬取项目深入调查报告

## 1. 调查概述

本报告基于对官方网站文档内容与爬取成果物的直接对比分析，针对`c:\Users\Demeri\Documents\trae_projects\markdown\docs\课题\抽检问题.md`中记录的问题进行深入调查。调查过程中严格以官方网站文档内容作为参照标准，对比爬取成果物与官方文档的差异点，记录具体不一致的位置、内容及表现形式。

## 2. 调查方法

### 2.1 数据来源

- **官方网站文档**：通过Playwright直接访问目标URL获取原始HTML内容
- **爬取成果物**：`data/markdown`目录下的Markdown文件
- **爬虫代码**：分析`src/crawler`目录下的爬虫实现

### 2.2 对比方法

1. 使用Playwright访问官方网站，获取原始HTML内容
2. 提取HTML中的关键元素：标题、段落、图片、列表、链接等
3. 将提取的元素与爬取的Markdown文件内容进行逐行对比
4. 记录所有不一致的位置、内容及表现形式
5. 分析爬虫代码，查找问题产生的原因

### 2.3 工具使用

- **Playwright**：用于访问官方网站，获取原始HTML内容
- **BeautifulSoup**：用于解析HTML内容
- **Markdownify**：用于HTML到Markdown的转换（爬虫使用）

## 3. 数据对比结果

### 3.1 对比样本

| 项目 | 内容 |
|------|------|
| 官方网站URL | https://act.mihoyo.com/ys/ugc/tutorial/detail/mhogfq9bf86q |
| 爬取成果物 | data/markdown/背包_mhogfq9b.md |
| 对比方式 | 逐行对比 |

### 3.2 详细对比结果

#### 3.2.1 图片链接对比

| 位置 | 官方网站内容 | 爬取成果物内容 | 差异表现 |
|------|--------------|----------------|----------|
| Line 11 | `<img style="width: 498px;aspect-ratio:1;" data-src="https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/7ba83e87-2d39-467d-b91a-b9bfb106efe9.png" class="lazy entered loaded" data-ll-status="loaded" src="https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/7ba83e87-2d39-467d-b91a-b9bfb106efe9.png">` | `![](https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/7ba83e87-2d39-467d-b91a-b9bfb106efe9.png)` | 爬取结果直接使用了CDN链接，未转换为本地链接 |
| Line 15 | `<img style="width: 1399px;aspect-ratio:1.66746126340882;" data-src="https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/31e04afa-6ec3-4671-81fb-eb576793f85f.png" class="lazy">` | `![]()` | 爬取结果为空头片链接，缺失了实际图片URL |
| Line 53 | `<img style="width: 748px;aspect-ratio:0.6151315789473685;" data-src="https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/528d01a8-646a-4475-af8c-3754a4e90d4e.png" class="lazy">` | `![]()` | 爬取结果为空头片链接，缺失了实际图片URL |

#### 3.2.2 列表格式对比

| 位置 | 官方网站内容 | 爬取成果物内容 | 差异表现 |
|------|--------------|----------------|----------|
| 基础属性列表 | `<div class="prosemirror-list-new" data-node-id="N-qncymmX9wK7UAN3hG8iw" data-list-kind="bullet" data-list-indent="1" data-list-style="'\e69c':0|'\e69c':0|'\e69c':0" style="--list-indent: 1;--list-type: '\e69c';--list-content: '\e69c';--ordered-list-index-size: 16px;--bullet-list-index-size: 8px;" id="N-qncymmX9wK7UAN3hG8iw" data-block-mark="{&quot;textStyle&quot;:{&quot;backgroundColor&quot;:&quot;&quot;}}"><div class="list-marker list-marker-click-target"></div><div class="list-content"><span style="color: rgba(89,111,254,1)"><em>背包格数量</em></span><span>：初始的背包内栏位数量，每一个背包栏位可以容纳一种道具，并根据堆叠数量可能堆叠多个</span></div></div>` | `` <br><br> `*背包格数量*：初始的背包内栏位数量，每一个背包栏位可以容纳一种道具，并根据堆叠数量可能堆叠多个` | 爬取结果缺失了正确的Markdown列表格式，仅保留了占位符号"" |

#### 3.2.3 链接对比

| 位置 | 官方网站内容 | 爬取成果物内容 | 差异表现 |
|------|--------------|----------------|----------|
| Line 51 | `<span class="CardKMLink"><a rel="noopener noreferrer nofollow" href="/ys/ugc/tutorial//detail/mh5y5001vqd4">背包组件</a></span>` | `[背包组件](/ys/ugc/tutorial//detail/mh5y5001vqd4)` | 爬取结果直接使用了相对链接，未转换为本地文件链接 |

#### 3.2.4 特殊字符对比

| 位置 | 官方网站内容 | 爬取成果物内容 | 差异表现 |
|------|--------------|----------------|----------|
| 列表标记 | `<div class="list-marker list-marker-click-target"></div>` | `` | 爬取结果保留了HTML中的特殊字符""，未转换为正确的Markdown列表符号 |

## 4. 问题定位过程

### 4.1 图片链接问题

**问题表现**：
- 爬取结果直接使用了CDN链接，未转换为本地链接
- 部分图片链接为空

**定位过程**：
1. 分析爬虫代码中的`parse_content`方法（`src/crawler/parser.py` Line 84）
2. 发现爬虫使用`markdownify.markdownify()`将HTML转换为Markdown
3. 转换过程中，图片标签被直接转换为Markdown格式，但未进行本地下载和链接替换
4. 查看`crawl_single_page`方法（`src/main.py` Line 119-128），发现虽然图片被下载到本地，但Markdown文件中的链接未被更新

**证据**：
- 本地图片目录`data/images`中存在已下载的图片文件
- Markdown文件中的图片链接仍为原始CDN链接
- 空图片链接对应官方网站中的懒加载图片（`class="lazy"`）

### 4.2 空图片链接问题

**问题表现**：官方网站中存在图片，但爬取结果为空头片链接

**定位过程**：
1. 分析官方网站HTML，发现空图片链接对应懒加载图片（带有`data-src`属性，而非`src`属性）
2. 检查爬虫代码中的`parse_images`方法（`src/crawler/parser.py` Line 109-121）
3. 发现该方法仅提取`src`属性，而懒加载图片使用`data-src`属性

**证据**：
- 官方网站HTML中，懒加载图片使用`data-src`属性：`<img data-src="https://example.com/image.png" class="lazy">`
- 爬虫代码仅提取`src`属性：`src = img_tag['src']`

### 4.3 不明占位符号问题

**问题表现**：爬取结果中存在不明占位符号""

**定位过程**：
1. 分析官方网站HTML，发现占位符号""是自定义列表的标记
2. 检查爬虫代码中的`markdownify.markdownify()`转换过程
3. 发现转换过程中，自定义列表的HTML结构未被正确转换为Markdown列表格式，仅保留了列表标记""

**证据**：
- 官方网站HTML中，列表结构为：`<div class="prosemirror-list-new"><div class="list-marker"></div><div class="list-content">内容</div></div>`
- Markdownify无法识别自定义列表结构，仅保留了文本内容

### 4.4 无效跳转链接问题

**问题表现**：爬取结果中存在外部跳转链接，未转换为本地文件链接

**定位过程**：
1. 分析爬虫代码中的链接处理逻辑
2. 发现`parse_content`方法直接将HTML中的链接转换为Markdown格式，未进行本地化处理
3. 检查`crawl_single_page`方法，发现未对Markdown文件中的链接进行二次处理

**证据**：
- 官方网站HTML中的链接：`<a href="/ys/ugc/tutorial//detail/mh5y5001vqd4">背包组件</a>`
- 爬取结果中的链接：`[背包组件](/ys/ugc/tutorial//detail/mh5y5001vqd4)`
- 本地存在对应的Markdown文件：`data/markdown/背包组件_mh5y5001.md`

### 4.5 无序列表标志丢失问题

**问题表现**：官方网站中有序列表标志，但爬取结果中缺失

**定位过程**：
1. 分析官方网站HTML，发现列表使用了自定义的CSS样式
2. 检查爬虫代码中的`markdownify.markdownify()`转换过程
3. 发现转换过程中，自定义列表结构未被正确识别为Markdown列表

**证据**：
- 官方网站HTML中，列表使用了自定义属性：`data-list-kind="bullet"`
- Markdownify无法识别自定义列表属性，仅保留了文本内容

## 5. 明确结论

### 5.1 图片链接问题

**结论**：爬虫程序虽然下载了图片到本地，但未更新Markdown文件中的图片链接，导致爬取结果直接使用了原始CDN链接。

**证据**：
- 本地图片目录`data/images`中存在已下载的图片文件
- Markdown文件中的图片链接仍为CDN链接
- 爬虫代码中缺少链接替换逻辑

### 5.2 空图片链接问题

**结论**：爬虫程序仅提取图片标签的`src`属性，而官方网站中使用了懒加载图片，图片URL存储在`data-src`属性中，导致部分图片链接为空。

**证据**：
- 官方网站HTML中，懒加载图片使用`data-src`属性
- 爬虫代码仅提取`src`属性：`src = img_tag['src']`

### 5.3 不明占位符号问题

**结论**：官方网站使用了自定义的列表结构，Markdownify无法正确识别，导致爬取结果中保留了原始HTML中的特殊字符""。

**证据**：
- 官方网站HTML中，列表使用了自定义的CSS类和结构
- Markdownify转换结果中保留了原始的列表标记""

### 5.4 无效跳转链接问题

**结论**：爬虫程序直接将HTML中的链接转换为Markdown格式，未进行本地化处理，导致爬取结果中存在外部跳转链接。

**证据**：
- 官方网站HTML中的链接为相对链接
- 爬取结果中的链接未转换为本地文件链接
- 本地存在对应的Markdown文件

### 5.5 无序列表标志丢失问题

**结论**：官方网站使用了自定义的列表样式，Markdownify无法正确识别，导致爬取结果中缺失了列表标志。

**证据**：
- 官方网站HTML中，列表使用了自定义的CSS样式和属性
- 爬取结果中仅保留了列表内容，缺失了列表标志

## 6. 修复建议

### 6.1 图片链接问题修复建议

1. **修改爬虫代码**：在`crawl_single_page`方法中，添加链接替换逻辑，将Markdown文件中的CDN链接替换为本地相对路径
2. **实现**：
   - 在图片下载完成后，记录`img_url`与本地文件名的映射关系
   - 使用正则表达式替换Markdown文件中的图片链接

### 6.2 空图片链接问题修复建议

1. **修改爬虫代码**：在`parse_images`方法中，同时提取`data-src`属性
2. **实现**：
   ```python
   def parse_images(self, soup):
       images = []
       for img_tag in soup.find_all('img'):
           # 优先提取data-src属性，支持懒加载图片
           img_url = img_tag.get('data-src') or img_tag.get('src')
           if img_url:
               images.append(img_url)
       return images
   ```

### 6.3 不明占位符号问题修复建议

1. **修改爬虫代码**：在HTML转换为Markdown之前，预处理自定义列表结构
2. **实现**：
   - 使用BeautifulSoup查找自定义列表元素
   - 将自定义列表转换为标准HTML列表（`<ul>`和`<li>`）
   - 再使用Markdownify转换为Markdown格式

### 6.4 无效跳转链接问题修复建议

1. **修改爬虫代码**：在Markdown生成后，添加链接转换逻辑
2. **实现**：
   - 建立文档ID与本地文件名的映射关系
   - 使用正则表达式替换Markdown文件中的外部链接为本地文件链接

### 6.5 无序列表标志丢失问题修复建议

1. **修改爬虫代码**：在HTML转换为Markdown之前，预处理自定义列表结构
2. **实现**：
   - 与不明占位符号问题相同，将自定义列表转换为标准HTML列表

## 7. 附件

### 7.1 官方网站HTML样本

```html
<div class="doc-view tw-mb-9" style="min-height: calc(-769px + 100vh);">
    <h1 id="NcNp4KkQODafSUiLlkZ5gH" data-block-mark="{&quot;textStyle&quot;:{&quot;backgroundColor&quot;:&quot;&quot;}}" class="no-font-size"><span>一、背包的定义</span></h1>
    <p id="NV2Q75q0-xNcUsYNpELm71" data-block-mark="{&quot;textStyle&quot;:{&quot;backgroundColor&quot;:&quot;&quot;}}"><span>背包是整个资源系统的容器，背包管理持有者的所有虚拟道具、装备和货币。</span></p>
    <img style="width: 498px;aspect-ratio:1;" data-src="https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/7ba83e87-2d39-467d-b91a-b9bfb106efe9.png" class="lazy entered loaded" data-ll-status="loaded" src="https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/7ba83e87-2d39-467d-b91a-b9bfb106efe9.png">
    <div class="prosemirror-list-new" data-node-id="N-qncymmX9wK7UAN3hG8iw" data-list-kind="bullet" data-list-indent="1" data-list-style="'\e69c':0|'\e69c':0|'\e69c':0" style="--list-indent: 1;--list-type: '\e69c';--list-content: '\e69c';--ordered-list-index-size: 16px;--bullet-list-index-size: 8px;" id="N-qncymmX9wK7UAN3hG8iw" data-block-mark="{&quot;textStyle&quot;:{&quot;backgroundColor&quot;:&quot;&quot;}}">
        <div class="list-marker list-marker-click-target"></div>
        <div class="list-content"><span style="color: rgba(89,111,254,1)"><em>背包格数量</em></span><span>：初始的背包内栏位数量，每一个背包栏位可以容纳一种道具，并根据堆叠数量可能堆叠多个</span></div>
    </div>
    <span class="CardKMLink"><a rel="noopener noreferrer nofollow" href="/ys/ugc/tutorial//detail/mh5y5001vqd4">背包组件</a></span>
</div>
```

### 7.2 爬取成果物样本

```markdown
# 一、背包的定义

背包是整个资源系统的容器，背包管理持有者的所有虚拟道具、装备和货币。

在背包界面中，道具以槽位的方式进行展示，玩家可以在运行时对背包内的道具进行拆分，销毁或丢弃操作

# 二、背包的编辑

打开系统菜单，通过点击【货币与背包】按钮进入编辑界面

![](https://act-webstatic.mihoyo.com/ugc-tutorial/knowledge/cn/zh-cn/mhogfq9bf86q/7ba83e87-2d39-467d-b91a-b9bfb106efe9.png)

进入背包页签，进行背包模板的详细编辑

![]()

*背包模板名称*：由创作者(奇匠)定义的背包模板的命名

**基础属性**



*背包格数量*：初始的背包内栏位数量，每一个背包栏位可以容纳一种道具，并根据堆叠数量可能堆叠多个

# 三、背包运行时实例

在实际游玩时，背包模板定义由[背包组件](/ys/ugc/tutorial//detail/mh5y5001vqd4)进行引用并实例化

![]()

#
```

### 7.3 爬虫代码关键片段

```python
# 转换为Markdown格式
markdown_content = markdownify.markdownify(content, heading_style="ATX")

# 保存Markdown文件
filename = downloader.save_markdown(parsed_content['content'], title, MARKDOWN_DIR, doc_id)

# 下载图片
images_downloaded = 0
for img_url in images:
    downloaded_filename = downloader.download_image(img_url, IMAGES_DIR)
    if downloaded_filename:
        images_downloaded += 1
        logger.info(f"Downloaded image: {downloaded_filename}")
```

---

**报告生成时间**：2026-01-03
**报告生成人**：AI智能体
**调查范围**：`c:\Users\Demeri\Documents\trae_projects\markdown`
**报告类型**：深入调查报告