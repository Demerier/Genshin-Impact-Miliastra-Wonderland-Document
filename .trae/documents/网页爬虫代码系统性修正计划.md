# 网页爬虫代码系统性修正计划

## 1. 修复目标

根据《网页爬取项目深入调查报告》中的分析结论，对网页爬虫代码进行系统性修正，解决以下问题：

1. 图片链接问题：将CDN链接转换为本地相对路径
2. 空图片链接问题：支持懒加载图片的`data-src`属性
3. 不明占位符号问题：处理自定义列表结构
4. 无效跳转链接问题：实现链接本地化转换
5. 无序列表标志丢失问题：修复列表格式转换

## 2. 修复方案

### 2.1 修复图片链接问题

**修改文件**：`src/main.py`
**修改内容**：在`crawl_single_page`方法中，添加图片链接替换逻辑
**实现思路**：
- 下载图片时记录`img_url`与本地文件名的映射关系
- 使用正则表达式替换Markdown文件中的图片链接

### 2.2 修复空图片链接问题

**修改文件**：`src/crawler/parser.py`
**修改内容**：修改`parse_images`方法，支持懒加载图片的`data-src`属性
**实现思路**：
- 优先提取`data-src`属性，其次提取`src`属性
- 过滤空值，确保只有有效URL才被添加到图片列表

### 2.3 修复自定义列表问题

**修改文件**：`src/crawler/parser.py`
**修改内容**：修改`parse_content`方法，预处理自定义列表结构
**实现思路**：
- 使用BeautifulSoup查找自定义列表元素
- 将自定义列表转换为标准HTML列表（`<ul>`和`<li>`）
- 再使用Markdownify转换为Markdown格式

### 2.4 修复链接本地化问题

**修改文件**：`src/main.py`
**修改内容**：添加链接本地化转换逻辑
**实现思路**：
- 建立文档ID与本地文件名的映射关系
- 使用正则表达式替换Markdown文件中的外部链接为本地文件链接

## 3. 测试方案

### 3.1 测试环境

- 测试数据：复制`data/markdown`目录到`data/test_markdown`
- 测试图片：复制`data/images`目录到`data/test_images`
- 测试URL：使用测试URL进行单页面爬取测试

### 3.2 测试步骤

1. 运行修复后的爬虫，爬取测试URL
2. 对比爬取结果与官方网站内容
3. 检查图片链接是否转换为本地路径
4. 检查空图片链接是否被正确处理
5. 检查自定义列表是否正确转换
6. 检查链接是否本地化

### 3.3 测试指标

- 图片链接转换率：100%
- 空图片链接处理率：100%
- 自定义列表转换正确率：100%
- 链接本地化率：100%

## 4. 修复执行计划

1. **修复空图片链接问题**：修改`parse_images`方法
2. **修复自定义列表问题**：修改`parse_content`方法
3. **修复图片链接问题**：修改`crawl_single_page`方法
4. **修复链接本地化问题**：添加链接转换逻辑
5. **编写测试脚本**：验证修复效果
6. **执行测试**：在测试环境中验证修复效果
7. **生成测试报告**：记录测试结果和效果评估

## 5. 工作留痕要求

- 所有修改均需记录修改时间、修改人、修改原因、具体修改内容及预期效果
- 修改记录需包含完整的代码变更
- 测试过程需记录测试方案、测试结果及效果评估
- 最终提交包含修改记录、测试方案、测试结果及效果评估的完整报告