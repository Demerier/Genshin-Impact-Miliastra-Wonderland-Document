# 修复未解决问题的详细计划

## 1. 问题分析

### 1.1 问题2：空图片链接问题
- **根本原因**：在`main.py`的`crawl_single_page`函数中，处理空图片链接时，使用了简单的`replace`方法替换所有空图片链接为同一个图片，导致图片与位置匹配错误。
- **代码位置**：`c:\Users\Demeri\Documents\trae_projects\markdown\src\main.py` 第148-153行

### 1.2 问题6：特殊格式文本区分问题
- **根本原因**：`markdownify`库默认不保留颜色信息，需要自定义转换规则来保留HTML中的颜色样式。
- **代码位置**：`c:\Users\Demeri\Documents\trae_projects\markdown\src\crawler\parser.py` 第154行

## 2. 修复方案

### 2.1 修复问题2：空图片链接问题

**修改文件**：`c:\Users\Demeri\Documents\trae_projects\markdown\src\main.py`

**修复思路**：
1. 改进图片替换策略，使用正则表达式查找所有空图片链接
2. 按顺序将空图片链接与下载的图片进行匹配替换
3. 确保每个空图片链接对应一个唯一的图片

**具体修改**：
- 将第148-153行的代码替换为：使用`re.finditer`查找所有空图片链接的位置
- 按顺序将每个空图片链接替换为对应的下载图片
- 确保替换顺序与图片在页面中出现的顺序一致

### 2.2 修复问题6：特殊格式文本区分问题

**修改文件**：`c:\Users\Demeri\Documents\trae_projects\markdown\src\crawler\parser.py`

**修复思路**：
1. 自定义`markdownify`转换规则，保留带有颜色样式的HTML标签
2. 使用`extensions`或`converter_options`参数配置`markdownify`
3. 确保转换后的Markdown支持颜色显示

**具体修改**：
- 在第154行，配置`markdownify`的`converter_options`，保留颜色相关的HTML标签
- 自定义转换规则，处理带有`style`属性的`span`标签
- 确保转换后的Markdown格式支持颜色显示

## 3. 测试计划

### 3.1 问题2测试
- 测试文件：`c:\Users\Demeri\Documents\trae_projects\markdown\data\test_markdown\背包_mhogfq9b_test.md`
- 测试步骤：
  1. 运行爬虫程序，爬取背包相关页面
  2. 检查生成的Markdown文件中图片链接是否正确
  3. 验证图片与位置的对应关系

### 3.2 问题6测试
- 测试文件：`c:\Users\Demeri\Documents\trae_projects\markdown\data\markdown\读前须知_mh29wpic.md`
- 测试步骤：
  1. 运行爬虫程序，爬取读前须知页面
  2. 检查生成的Markdown文件中是否保留了颜色信息
  3. 验证红色斜体和蓝色斜体是否正确区分

## 4. 预期结果

1. **问题2**：修复后，空图片链接将被正确替换为对应位置的图片，每个图片链接对应一个唯一的图片。
2. **问题6**：修复后，Markdown文件中将保留颜色信息，红色斜体和蓝色斜体将被正确区分。

## 5. 修复优先级

1. 问题2：高优先级，影响图片显示正确性
2. 问题6：中优先级，影响文本格式区分

## 6. 修复时间

预计修复时间：2小时
- 问题2修复：30分钟
- 问题6修复：30分钟
- 测试验证：60分钟